<html>

<head>
<link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
<style type="text/css">
html,body {
	background: rgb(41, 41, 41);
}

#editor {
	height: 100%;
	width: 100%;
	border: 0;
	background: rgb(41, 41, 41);
	font-family: monospace;
	font-size: 14px;
	padding: 10px;
	color: #ddd;
	line-height: 1.35em;
	margin: 0;
	padding: 10;
}

#openViewer {
	position: absolute;
	bottom: 15px;
	right: 15px;
}
</style>
</head>

<body>
	<textarea id="editor" rows="50" cols="100"></textarea>
	<a id="openViewer" class="btn primary" onclick="openViewer()">Open
		Viewer</a>
</body>

<script type='text/javascript' src='/js/jquery.min.js'></script>
<script type="text/javascript">
	/* Add methods to String to get lines and count number of lines */
	String.prototype.lines = function() {
		return this.split(/\r*\n/);
	}
	String.prototype.lineCount = function() {
		return this.lines().length
				- (navigator.userAgent.indexOf("MSIE") != -1);
	}

	/* Prepare the editor data */
	var editor = $("#editor");
	var value = editor.val()

	var followCursor = true;
	var initialized = false;
	var syncTimeoutId;
	var viewerUpdateRequired = true;
	var viewerId;

	/* Editor methods */
	editor.keyup(function() {
		window.clearTimeout(syncTimeoutId);
		syncTimeoutId = window.setTimeout(sync, 250);
	});

	var sync = function() {
		window.clearTimeout(syncTimeoutId);

		if (value != editor.val()) {
			if (!load()) {
				value = editor.val();
				save();
			}
		}
	}

	var load = function() {
		var url = window.location;
		var loaded = false;

		console.log("Loading document [" + url + "]");

		$
				.ajax({
					url : url + "&serveContent",
					async : false,
					cache : false,
					dataType : "text",
					type : "GET",
					timeout : 5000
				})
				// Failure
				.fail(
						function(xhr, status, error) {
							console.log("Error loading document [" + url
									+ "] - [" + status + "-" + error + "]");
						})
				// Success
				.done(
						function(data) {
							if (value != data) {
								if (value != "") {
									var confirm = window
											.confirm("The document has changed on"
													+ " the filesystem. Load changes?");
									if (confirm) {
										editor.val(data);
										loaded = true;
									}
								} else {
									editor.val(data);
									loaded = true;
								}

								if (loaded) {
									value = data;
									viewerUpdateRequired = true;
								}
							}
						});

		initialized = true;
		return loaded;
	};

	var openViewer = function() {
		if (viewerOpen())
			viewerId = window.open(window.location.href.replace('/edit', ''));
	}

	var viewerOpen = function() {
		return !viewerId || viewerId.closed;
	}

	var save = function() {
		var url = window.location;
		viewerUpdateRequired = true;

		console.log("Saving document [" + url + "]");

		$.ajax({
			url : url,
			cache : false,
			data : "content=" + encodeURIComponent(editor.val()),
			dataType : "text",
			type : "POST"
		})
		// Failure
		.fail(
				function(xhr, status, error) {
					console.log("Error saving document [" + url + "] - ["
							+ status + "-" + error + "]");
				})
		// Success
		.done(function(html) {
			console.log("Saved document [" + url + "]");
		});
	};

	var syncCursorUpdateRequired = false;
	var syncCursorScrollPercent;
	var syncCursorTimeoutId;
	var syncCursor = function() {
		window.clearTimeout(syncCursorTimeoutId);
		if (followCursor) {

			/* calculate % by lines
			var totalLines = editor.val().split("\n").length;
			var currentLine = editor.val().substr(0, editor[0].selectionStart)
					.split("\n").length;

			if (currentLine > 0)
				currentLine = currentLine - 1;

			if (totalLines == 0)
				totalLines = 1;

			var newPercent = (currentLine * 100) / (totalLines * 100);
			 */

			var height = $(editor).height();
			var scrollTop = $(editor).scrollTop();
			var newPercent = scrollTop / height;

			if (newPercent != syncCursorScrollPercent) {
				syncCursorScrollPercent = newPercent;
				syncCursorUpdateRequired = true;
			}
		}
		syncCursorTimeoutId = window.setTimeout(syncCursor, 100);
	}

	load();
	syncCursor();
</script>

</html>